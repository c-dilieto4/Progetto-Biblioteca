@startuml
' Definizioni delle Classi
class Libro {
  -isbn: String 
  -titolo: String 
  -autore: List<String> 
  -anno: int 
  -copieTotali: int 
  -copieDisponibili: int 
  +Libro(isbn: String, titolo: String, autore: List<String>, anno: int)
  +getIsbn(): String
  +getTitolo(): String
  +getAutore(): List<String>
  +getCopieDisponibili(): int
  +incrementaDisponibilita(): void
  +decrementaDisponibilita(): void
  +isDisponibile(): boolean
}

class Utente {
  -matricola: String 
  -nome: String 
  -cognome: String 
  -email: String 
  +Utente(matricola: String, nome: String, cognome: String, email: String)
  +getMatricola(): String
  +aggiungiPrestito(p: Prestito): void
  +rimuoviPrestito(p: Prestito): void
  +verificaLimite(max: int): boolean
}

class Prestito {
  -idPrestito: int
  -libro: Libro 
  -utente: Utente 
  -dataInizioPrestito: LocalDate 
  -dataRestituzionePrevista: LocalDate 
  -dataRestituzioneeEffettiva: LocalDate 
  +Prestito(idPrestito: int, libro: Libro, utente: Utente, dataInizioPrestito: LocalDate, dataRestituzionePrevista: LocalDate)
  +getLibro(): Libro
  +getUtente(): Utente
  +chiudiPrestito(dataEffettiva: LocalDate): void
  +verificaRitardo(): boolean
}

class Catalogo {
  -collezioneLibri: Map<String, Libro> 
  +Catalogo()
  +getLibro(isbn: String): Libro
  +aggiungiLibro(l: Libro): boolean
  +rimuoviLibro(isbn: String): boolean
  +modificaLibro(isbn: String, l: Libro): boolean
  +cercaLibro(query: String, campo: String): List<Libro>
  +visualizzaOrdinata(): List<Libro>
}

class Anagrafica {
  -registroUtenti: Map<String, Utente> 
  +Anagrafica()
  +aggiungiUtente(u: Utente): boolean
  +rimuoviUtente(matr: String): boolean
  +modificaUtente(matr: String, u: Utente): boolean
  +getUtente(matr: String): Utente
  +cercaUtente(query: String, campo: String)
  +visualizzaOrdinata(): List<Utente>
}

class RegistroPrestiti {
  -catalogo: Catalogo 
  -anagrafica: Anagrafica
  -prestitiAttivi: List<Prestito> 
  -limitePrestiti: int 
  +RegistroPrestiti(catalogo: Catalogo, anagrafica: Anagrafica)
  +registraPrestito(isbn: String, matr: String, dataPrevistaRestituzione: LocalDate): Prestito
  +registraRestituzione(idPrestito: int): boolean
  +getPrestitiAttivi(): List<Prestito>
  +getPrestitiAttivi(u: Utente): List<Prestito>
  +getPrestitiInRitardo(): List<Prestito>
  +utenteHaPrestitiAttivi(u: Utente): boolean
}

class GUIController {
  -catalogo: Catalogo 
  -anagrafica: Anagrafica 
  -registro: RegistroPrestiti 
  -archivio: IArchivioDati
  -validatore: ValidatoreDati
  -logger: ILogger
  +GUIController(archivio: IArchivioDati, validatore: ValidatoreDati)
  +avviaSistema(): boolean
  +chiudiSistema(): boolean
  +aggiungiUtente(matricola: String, nome: String, cognome: String, email: String): boolean
  +aggiungiLibro(isbn: String, titolo: String, autore: List<String>, anno: int, CopieTotali: int): boolean
  +rimuoviUtente(matr: String): boolean
  +rimuoviLibro(isbn: String): boolean 
  +gestisciPrestito(isbn: String, matr: String): boolean
  +gestisciRestituzione(idPrestito: int): boolean
  +ottieniReportPrestiti(): List<Prestito>
  +ottieniCatalogoOrdinato(): List<Libro>
  +ottieniAnagraficaOrdinato(): List<Utente>
}

interface IArchivioDati{
   +salvaStato(dati: Object, nomeFile: String): boolean
   +caricaStato(nomeFile: String): Object
   +verificaEsistenzaFile(nomeFile: String): boolean
}

interface ILogger{
  +registraAzione(azione: String): void
  +caricaLog(): List<String>
  +salvaLog(): void
  +visualizzaLog(): List<String>
}

class AuditTrail {
  -logRecords: List<String>
  -archivioDati: IArchivioDati
  +AuditTrail(archivio: IArchivioDati)
  +registraAzione(azione: String): void
  +caricaLog(): List<String>
  +salvaLog(): void
  +visualizzaLog(): List<String>
}

class FileArchivio {
  -pathDati: String
  -logErrori: ILogger
  +FileArchivio(path: String)
  +salvaStato(dati: Object, nomeFile: String): boolean
  +caricaStato(nomeFile: String): Object
  +verificaEsistenzaFile(nomeFile: String): boolean
}

class ValidatoreDati {
  +validaISBN(isbn: String): boolean
  +validaMatricola(matr: String)
  +validaEmail(email: String)
  +validaAnnoPubblicazione(anno: int)
  +validaNomeCognome(str: String)
}

class GUIView {
  -sistema: GUIController
  -messaggi: MessaggiInterfaccia
  +GUIView(sistema: GUIController)
  +avviaInterfaccia(): void
  +gestisciAggiuntaLibro(): void
  +gestisciRegistrazionePrestito(): void
  +mostraListaLibri(lista: List<Libro>): void
  +mostraListaPrestiti(lista: List<Prestito>): void
  +mostraMessaggio(msg: MessaggiInterfaccia): void
}

class MessaggiInterfaccia {
  +String SUCCESSO_AGGIUNTA_LIBRO
  +String SUCCESSO_PRESTITO
  +String ERRORE_LIMITE_PRESTITO
  +String ERRORE_ISBN_DUPLICATO
  +String ERRORE_MATRICOLA_DUPLICATA
  +String ERRORE_ASSENZA_COPIE
  +String INPUT_EMAIL_NON_VALIDA
  +String INPUT_NOME_NON_VALIDO
  +String INPUT_COGNOOME_NON_VALIDO
  +String ANNO_NON_VALIDO
  +String ERRORE_MATRICOLA
  +String RITARDO_SEGNALATO
  +String AVVISO_CARICAMENTO_FALLITO
}

' Interfacce (come da tue specifiche)
interface IAuditTrail <<Interface>>
interface IArchivioDati <<Interface>>

' Correzione dei nomi delle classi che implementano le interfacce per evitare ambiguità
AuditTrail .up.|> IAuditTrail
ArchivioDati .up.|> IArchivioDati

' Ereditarietà / Implementazione
AuditTrail ..|> ILogger
FileArchivio ..|> IArchivioDati

' Composizioni (Il tutto gestisce le parti)
Catalogo "1" *--> "0..*" Libro
Anagrafica "1" *--> "0..*" Utente
RegistroPrestiti "1" *--> "0..*" Prestito

' Associazioni Unidirezionali (Il prestito punta a Libro e Utente, non viceversa)
Prestito --> "1" Libro 
Prestito --> "1" Utente

' Dipendenza "soft" (L'utente ha una lista interna per cache/limite, ma è gestita dal registro)
Utente "1" ..> "0..3" Prestito

' Aggregazioni del Controller (Facade)
GUIController o--> "1" Catalogo
GUIController o--> "1" Anagrafica
GUIController o--> "1" RegistroPrestiti

' Dipendenze Architetturali (Risolto il ciclo: FileArchivio non dipende più da ILogger)
GUIController ..> IArchivioDati
GUIController ..> ILogger

' AuditTrail usa l'archivio per salvare
AuditTrail --> IArchivioDati

' Dipendenze d'uso (Use)
GUIView ..> GUIController
GUIView ..> MessaggiInterfaccia
Catalogo ..> ValidatoreDati
Anagrafica ..> ValidatoreDati
GUIController ..> ValidatoreDati
@enduml